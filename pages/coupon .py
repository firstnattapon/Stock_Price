import streamlit as st
import pandas as pd
import requests
import json

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(
    page_title="Dashboard ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
    page_icon="üé´",
    layout="wide"
)

# URL ‡∏Ç‡∏≠‡∏á Firebase (‡∏ï‡∏±‡∏î .json ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
BASE_URL = "https://smart-washer-a830b-default-rtdb.asia-southeast1.firebasedatabase.app/coupons"

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Read)
def load_data():
    try:
        response = requests.get(f"{BASE_URL}.json")
        response.raise_for_status()
        data = response.json()
        return data
    except Exception as e:
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}")
        return None

# 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Create/Update)
def add_coupon(coupon_id, status, value=None):
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö node ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô /coupons/11111.json
    url = f"{BASE_URL}/{coupon_id}.json"
    
    # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
    payload = {
        "status": status,
        "value": value,
        "timestamp": pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    
    try:
        # ‡πÉ‡∏ä‡πâ PUT ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏ ID ‡πÄ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ POST Firebase ‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏° ID ‡∏¢‡∏≤‡∏ß‡πÜ ‡πÉ‡∏´‡πâ)
        response = requests.put(url, json=payload)
        response.raise_for_status()
        return True
    except Exception as e:
        st.error(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        return False

# --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å (Main Interface) ---
st.title("üé´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (Smart Washer)")
st.markdown("---")

# ==========================================
# ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: Sidebar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Add Data)
# ==========================================
with st.sidebar:
    st.header("‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á")
    
    with st.form("add_coupon_form"):
        # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á 11111 - 99999 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        new_id = st.number_input(
            "‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (5 ‡∏´‡∏•‡∏±‡∏Å)", 
            min_value=11111, 
            max_value=99999, 
            step=1,
            help="‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 11111 ‡∏ñ‡∏∂‡∏á 99999"
        )
        
        new_status = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", ["active", "used", "expired"])
        new_value = st.number_input("‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)", min_value=0, value=100)
        
        submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
        
        if submitted:
            if 11111 <= new_id <= 99999:
                success = add_coupon(new_id, new_status, new_value)
                if success:
                    st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á {new_id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
                    st.cache_data.clear() # ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache
                    # ‡πÉ‡∏ä‡πâ rerun ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    st.rerun()
            else:
                st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (11111-99999)")

# ==========================================
# ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (View Data)
# ==========================================

# ‡∏õ‡∏∏‡πà‡∏° Refresh
if st.button("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
    st.cache_data.clear()
    st.rerun()

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
data = load_data()

if data:
    # ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    if isinstance(data, dict):
        items = []
        for key, value in data.items():
            if isinstance(value, dict):
                value['coupon_code'] = key # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ key ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                items.append(value)
            else:
                items.append({'coupon_code': key, 'value': value})
        df = pd.DataFrame(items)
        
    elif isinstance(data, list):
        # ‡∏Å‡∏£‡∏ì‡∏µ List ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ index ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
        # ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤ Firebase ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô array ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ null ‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á clean
        items = []
        for i, val in enumerate(data):
            if val is not None:
                if isinstance(val, dict):
                    val['coupon_code'] = i
                    items.append(val)
                else:
                    items.append({'coupon_code': i, 'value': val})
        df = pd.DataFrame(items)
    else:
        df = pd.DataFrame()

    if not df.empty:
        # ‡∏¢‡πâ‡∏≤‡∏¢ coupon_code ‡∏°‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å
        if 'coupon_code' in df.columns:
            cols = df.columns.tolist()
            cols.insert(0, cols.pop(cols.index('coupon_code')))
            df = df[cols]
            
            # ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á comma (‡πÄ‡∏ä‡πà‡∏ô 11,111)
            df['coupon_code'] = df['coupon_code'].astype(str) 

        # Metric
        c1, c2, c3 = st.columns(3)
        with c1:
            st.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{len(df)} ‡πÉ‡∏ö")
        with c2:
            # ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Active
            if 'status' in df.columns:
                active_count = len(df[df['status'] == 'active'])
                st.metric("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active", f"{active_count} ‡πÉ‡∏ö")
            else:
                st.metric("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active", "-")

        st.subheader("üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á")
        st.dataframe(
            df, 
            use_container_width=True,
            hide_index=True
        )
    else:
        st.info("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á")
else:
    st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
