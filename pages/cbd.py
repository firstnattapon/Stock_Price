import streamlit as st
import folium
from streamlit_folium import st_folium

# =========================================================
# üîë KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
# =========================================================
# Key: c344fe69c29a9ff359ce658802837c81
API_KEY = "490db764853b3693bfc798046c5e0a62"

st.set_page_config(layout="wide")
st.title("‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡πÇ‡∏´‡∏°‡∏î WMS ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)")

if not API_KEY:
    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö API Key")
else:
    # ‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ Zoom 17 (‡∏ã‡∏π‡∏°‡∏•‡∏∂‡∏Å‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
    m = folium.Map(location=[20.2604, 100.4100], zoom_start=17)

    # 1. Base Map (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á)
    folium.TileLayer("CartoDB positron", name="‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á").add_to(m)

    # 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (DOL Parcels) - ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö WMS
    # URL ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ?request=GetMap&service=WMS... ‡πÑ‡∏õ‡∏´‡∏≤ Server ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    # ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 'unknown WMS request type' ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏à‡∏≠‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
    wms_base_url = f"https://ms.longdo.com/mapproxy/service/wms?apikey={API_KEY}"
    
    folium.raster_layers.WmsTileLayer(
        url=wms_base_url,
        layers="dol_parcels",       # ‡∏ä‡∏∑‡πà‡∏≠ Layer ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
        fmt="image/png",            # ‡∏Ç‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û PNG
        transparent=True,           # ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
        version="1.1.1",            # ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô WMS
        attr="Longdo Map / ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô",
        name="üìú ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô)",
        overlay=True,
        control=True,
        show=True
    ).add_to(m)

    # ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Layer
    folium.LayerControl(collapsed=False).add_to(m)
    
    st.success(f"üîë ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ Key: ...{API_KEY[-6:]}")
    st.info("üí° **‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï:** ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á/‡∏™‡πâ‡∏° ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö (Layer ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ã‡∏π‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÜ)")
    
    st_folium(m, height=600, use_container_width=True)
