import streamlit as st
import pandas as pd
import numpy as np
import pydeck as pdk

def haversine(lat1, lon1, lat2, lon2):
    """
    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÇ‡∏•‡∏Å (Haversine formula)
    ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£ (km)
    """
    R = 6371  # ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å (km)

    # ‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ô
    lat1_rad, lon1_rad, lat2_rad, lon2_rad = map(np.radians, [lat1, lon1, lat2, lon2])

    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á
    dlon = lon2_rad - lon1_rad
    dlat = lat2_rad - lat1_rad

    # ‡∏™‡∏π‡∏ï‡∏£ Haversine
    a = np.sin(dlat / 2)**2 + np.cos(lat1_rad) * np.cos(lat2_rad) * np.sin(dlon / 2)**2
    c = 2 * np.arcsin(np.sqrt(a))
    
    distance = R * c
    return distance

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Streamlit ---
st.set_page_config(layout="wide")
st.title("üó∫Ô∏è Rent Gradient Map Simulator")
st.markdown("""
‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á **‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (Bid-Rent Theory)** ‡∏ã‡∏∂‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
(‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô) ‡∏à‡∏∞‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á (CBD) ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô

- **‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á** ‡∏Ñ‡∏∑‡∏≠ Heatmap ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤"
- **‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏á** ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á
- **‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏∑‡∏î/‡πÄ‡∏¢‡πá‡∏ô** ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≥
- ‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•
""")

# --- ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á (Sidebar) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö Input ---
st.sidebar.header("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏• (Model Settings)")

# 1. ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á CBD (‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
st.sidebar.subheader("1. ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á (CBD)")
cbd_lat = st.sidebar.slider("‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (Latitude)", 13.70, 13.80, 13.7563, 0.0001, format="%.4f")
cbd_lon = st.sidebar.slider("‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (Longitude)", 100.45, 100.55, 100.5018, 0.0001, format="%.4f")

# 2. ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤
st.sidebar.subheader("2. ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (Rent Parameters)")
max_rent = st.sidebar.slider("‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà CBD (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏£.‡∏°.)", 1000, 50000, 20000)
falloff_distance = st.sidebar.slider("‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô 0 (‡∏Å‡∏°.)", 10.0, 100.0, 50.0, 0.5)

# 3. ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
st.sidebar.subheader("3. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Map Settings)")
num_points = st.sidebar.slider("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap)", 1000, 15000, 7000)
radius_pixels = st.sidebar.slider("‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏±‡∏®‡∏°‡∏µ Heatmap (pixels)", 20, 100, 60)
map_pitch = st.sidebar.slider("‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏≠‡∏á‡∏®‡∏≤)", 0, 60, 45)


# --- ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Generation) ---

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≠‡∏ö CBD
# 1 ‡∏≠‡∏á‡∏®‡∏≤‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î ~ 111 ‡∏Å‡∏°.
# 1 ‡∏≠‡∏á‡∏®‡∏≤‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î ~ 111 * cos(lat) ‡∏Å‡∏°.
lat_spread = falloff_distance / 111 * 1.5  # ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
lon_spread = falloff_distance / (111 * np.cos(np.radians(cbd_lat))) * 1.5

# ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame
df = pd.DataFrame()
df['lat'] = np.random.uniform(cbd_lat - lat_spread, cbd_lat + lat_spread, num_points)
df['lon'] = np.random.uniform(cbd_lon - lon_spread, cbd_lon + lon_spread, num_points)

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å CBD ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤
df['distance_km'] = haversine(cbd_lat, cbd_lon, df['lat'], df['lon'])

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
# rent = max_rent * (1 - (distance / falloff_distance))
# ‡∏ñ‡πâ‡∏≤ distance > falloff_distance, rent = 0
df['rent'] = df['distance_km'].apply(lambda d: max(0, max_rent * (1 - d / falloff_distance)))

# ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
df['distance_km'] = df['distance_km'].round(2)
df['rent'] = df['rent'].round(0).astype(int)

# ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ > 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Heatmap ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
df_display = df[df['rent'] > 0]


# --- ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Map Visualization) ---

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
view_state = pdk.ViewState(
    latitude=cbd_lat,
    longitude=cbd_lon,
    zoom=10,
    pitch=map_pitch, # ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏≠‡∏µ‡∏¢‡∏á
    bearing=0
)

# 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Layer (HeatmapLayer)
heatmap_layer = pdk.Layer(
    "HeatmapLayer",
    data=df_display,
    get_position="[lon, lat]",  # Pydeck ‡πÉ‡∏ä‡πâ [lon, lat]
    get_weight="rent",          # ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤
    radius_pixels=radius_pixels,
    intensity=1,
    threshold=0.03,
    color_range=[           # ‡πÑ‡∏•‡πà‡∏™‡∏µ (‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô -> ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß -> ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á -> ‡πÅ‡∏î‡∏á)
        [5, 87, 150],
        [68, 182, 194],
        [254, 252, 154],
        [254, 178, 76],
        [252, 78, 42],
        [189, 0, 38]
    ]
)

# 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Deck (‡∏ï‡∏±‡∏ß‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)
deck = pdk.Deck(
    map_style="mapbox://styles/mapbox/light-v9", # ‡πÉ‡∏ä‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏ß‡πà‡∏≤‡∏á
    initial_view_state=view_state,
    layers=[heatmap_layer],
    tooltip={
        "html": """
            <b>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (Rent):</b> {rent} ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏£.‡∏°.<br/>
            <b>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á (Distance):</b> {distance_km} ‡∏Å‡∏°.
            """,
        "style": {
            "backgroundColor": "steelblue",
            "color": "white",
            "fontFamily": '"Helvetica Neue", Arial, sans-serif',
            "fontSize": "12px",
            "padding": "5px"
        }
    }
)

# ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô Streamlit
st.pydeck_chart(deck, use_container_width=True)


# --- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ---
st.subheader("‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Sample Data)")
st.markdown("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î Heatmap")
st.dataframe(df_display.sample(5))
