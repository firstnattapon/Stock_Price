import streamlit as st
import openrouteservice
import folium
from streamlit_folium import st_folium

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(
    page_title="Isochrone Map Generator",
    page_icon="üó∫Ô∏è",
    layout="wide"
)

# --- üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Data Cache) ---
if 'isochrone_data' not in st.session_state:
    st.session_state.isochrone_data = None  # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API
if 'map_center' not in st.session_state:
    st.session_state.map_center = [13.7649, 100.5382] # ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

st.title("üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (Isochrone Map)")

# --- 2. Sidebar ---
with st.sidebar:
    st.header("‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤")
    
    default_key = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjA0ZWVmNTA0Y2Y4YzQ3ZDZhZTYzNTFjNDEyZWY3OTRiIiwiaCI6Im11cm11cjY0In0="
    
    api_key = st.text_input(
        "OpenRouteService API Key", 
        value=default_key,
        type="password", 
        help="‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà openrouteservice.org"
    )
    
    st.markdown("---")
    
    travel_mode = st.selectbox(
        "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        options=["driving-car", "foot-walking", "cycling-regular"],
        index=0,
        format_func=lambda x: "üöó ‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" if x == "driving-car" else ("üö∂ ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤" if x == "foot-walking" else "üö≤ ‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô")
    )
    
    time_minutes = st.slider("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡∏ô‡∏≤‡∏ó‡∏µ)", min_value=1, max_value=60, value=15)
    
    # ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
    submit_button = st.button("üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", use_container_width=True)

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î ---
col1, col2 = st.columns(2)
with col1:
    lat_input = st.number_input("‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (Latitude)", value=13.7649, format="%.6f")
with col2:
    lon_input = st.number_input("‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (Longitude)", value=100.5382, format="%.6f")

# --- üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 2: ‡∏¢‡πâ‡∏≤‡∏¢ Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ó‡∏≥‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°) ---
if submit_button:
    if not api_key:
        st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
    else:
        with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...'):
            try:
                client = openrouteservice.Client(key=api_key)
                range_seconds = time_minutes * 60
                center_point_ors = [lon_input, lat_input]
                
                # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
                isochrone = client.isochrones(
                    locations=[center_point_ors],
                    profile=travel_mode,
                    range=[range_seconds]
                )
                
                # ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡∏á‡πÉ‡∏ô Session State
                st.session_state.isochrone_data = isochrone
                st.session_state.map_center = [lat_input, lon_input] # ‡∏à‡∏≥‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ
                
            except openrouteservice.exceptions.ApiError as api_err:
                 st.error(f"‚ùå API Key ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°: {api_err}")
            except Exception as e:
                st.error(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")

# --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Session State ‡∏°‡∏≤‡∏ß‡∏≤‡∏î) ---
def display_map():
    # ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å Session State (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πà‡∏≤ Default)
    center = st.session_state.map_center
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    m = folium.Map(location=center, zoom_start=13, tiles="CartoDB positron")
    
    # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Isochrone (‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à) ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏•‡∏á‡πÑ‡∏õ
    if st.session_state.isochrone_data:
        folium.GeoJson(
            st.session_state.isochrone_data,
            name='Available Area',
            style_function=lambda x: {
                'fillColor': '#00C896',
                'color': '#008F6B',
                'weight': 2,
                'fillOpacity': 0.4
            }
        ).add_to(m)
        
        # ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
        folium.Marker(
            center,
            popup="‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
            icon=folium.Icon(color="red", icon="home")
        ).add_to(m)
        
        st.success(f"‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")
    else:
        # ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏£‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏ó‡∏≤‡πÜ ‡πÑ‡∏ß‡πâ
        folium.Marker(center, icon=folium.Icon(color="gray", icon="info-sign")).add_to(m)

    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ st_folium
    # key="main_map" ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ Streamlit ‡∏à‡∏≥ component ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
    st_folium(m, width=1200, height=600, key="main_map") 

    # ‡πÅ‡∏™‡∏î‡∏á JSON
    if st.session_state.isochrone_data:
        with st.expander("üõ†Ô∏è ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏î‡∏¥‡∏ö"):
            st.json(st.session_state.isochrone_data)

# --- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
display_map()
